# 云开发

使用云开发可以替代或者弱化后台，把云端作为后端，无需开发后端，搭建后端服务器。也就是把数据文件都管理到云端。

云开发可以使用平台提供的API对云端的数据或者文件进行访问。

### 云开发步骤

### 1. 在创建小程序时，勾选使用云开发

### 2.在开发者工具中，工具栏点击云开发，配置一个云环境。

### 3.可以使用云开发相关API访问云端

​	要在小程序端调试云开发API，步骤

1. 初始化

   因为初始化只需要做一次，所以放到app.js的onLaunch中。

   ```js
   wx.cloud.init({
   	env:"test-otzzp"
   }),
   ```

2. 使用wx.cloud调用云开发API

   共有三种API,分别是数据库，存储，云函数

### 数据库

云端数据库是一种文档式（document)数据库，文档式数据库的接口：

数据库系统--->database--->collection--->doc--->filed

### 1. database 

* 获取某个环境下的database

  ```js
  //一般不用指定环境，默认使用init初始时的环境
  var db = wx.clound.database({
  	env:'test-otaap'
  })
  ```

### 2.collection

* 创建collection(已废弃)

  ````js
  db.createCollection("collection的名字")；
  //collection相当于关系型数据可以中table表
  ````

* 获取collection

  ```js
  var coll = db.collection("collection名字")；
  //如果collection不存在，会自动创建
  ```

### 3.doc

* 往collection中添加doc

  每个doc都有一个唯一的doc_id，这个doc_id一般自动生成。

  ```js
  var doc1 = {gid:20200001,ganame:"华为手机"，gprice:29999};
  coll.add(doc1);
  //会自动添加_id和_openId
  ```

* 查询doc

  1. 第一种：coll.doc(_id)

     通过_id直接查询某一个doc

  2. 第二种：coll.get()

     通过条件查询。where可以设置条件。默认查询所有

  3. where条件

     where条件是一个对象，可以按照filed设置各种查询条件。

     多个filed条件之间默认是and关系

     在设置field条件时。可以使用各种条件命令，database.command中定义的命令。

     1. lt 小于
     2. gt  大于
     3. eq 等于
     4. lte 小于等于
     5. gte  大于等于
     6. neq  不等于
     7. in 在某个范围内
     8. nin 不在某个范围内
     9. and 
     10. or

* 修改

  1. 第一种update

      update是一种局部修改，就是可以自己指定要修改那些filed ,没指定的不做修改

     * 可以按照_id修改一个doc

        coll.doc(_id).update()

     * 也可按找whree调价修改多个doc

       coll.where().update()

       注意where+update修改多条 只能在运算（云函数)

  2. set

      set是一种替换修改，就是把整个doc替换掉，就相当于修改了所有filed

      coll.doc(_id).set()

  3. 修改指令

      * set(赋值默认)
      * inc
      * mul
      * remove 
      * push
      * pop
      * shift
      * unshift

*   删除remove

  1. 可以按照_id删除一个doc

     coll.doc(_id).remove()

  2. 也可以按照where条件删除多个doc

* 分页查询

  coll.skip(skipRows).limit(pageSize).get()

### 存储

云存储，是一个云端的文件系统，可以把小程序端的文件上传到云存储中，也可从云存储中下载文件。

1. 上传文件

   wx.cloud.uploadFile()

2. 下载文件

   wx.cloud.downFile()

3. 删除文件

   wx.cloud.deleteFile()

4. 获取文件临时URL

   wx.cloud.getTempFileURL()

### 云函数

在云端执行的函数

1. 先在小程序中开发好云函数，上传到云端。

   * 新建一个问价夹cloudfunctions，在project.config.json中配置这个文件作为云函数根目录。

     'cloudfunctionRoot':'cloudfunctions/'

   * 在文件夹下右键，新建一个nodejs云函数

     一个云函数包含一个index.js文件和一个package.json配置文件。

     index.js文件中定义云函数

     package.json中配置指定云函数的函数名，版本，还有对应的js文件的路径。

   * 创建云函数。

     ```js
     //云函数入口
     exports.main = async (event, context) => {
       //云函数的函数体
       return {"message": "hello world"};
     }
     ```

   * 上传部署云函数

     云函数目录，右键上传并部署

2. 在小程序端调用云函数

   wx.cloud.callfunction()

3. 云函数在云端执行，那么如果云函数中要访问云（数据库，存储，云函数）

   * 小程序端fangwenyun

     1. wx.cloud.init()
     2. wx.cloud调用云API

   * 在云端（云函数）访问云：

     1. 加载sdk

        const cloud = require("wx-server-sdk")

     2. 初始化

        cloud.init()

     3. 使用cloud.调用各种云API

###  云端数据管理

运算数据的后台数据管理，可以有三种方式：

1. 使用云开发控制台，在控制台管理云端的数据库，存储和云函数。

   这种方式，控制台是要依赖开发者工具的。

2. 专门开发一个小程序，作后台云端数据管理

   小程序中调用云API,管理数据库，存储和云函数。

   但是小程序一般只做前台，不做后台管理。

3. 使用其他开发语言，开发一个专门的后台管理系统。

   可以使用各种开发语言：nodejs jave c# php python....

这种后天系统中可以使用HTTP API 访问云端，从而实现对云端数据库、存储和云函数的管理

* 首先要调用HTTP API ，需要先获取到小程序账号对应的access_token

  怎么获取这个access_token:

  发送一个get请求，请求参数包含appId和secret。

  appid和secret可以在小程序找好后天管理中提取到

  appID: wx99c4c0b177992012

  secret:3e0913abcd93b0ad09fa6b7de1194f02

  ```js
  GET https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&appid=APPID&secret=APPSECRET
  相应结果：access_token:
  "access_token": "access_token": 32_FSLWwDwpfo_YKKaV6BxTj9q5z_jpKmHM6fQIKzZOGIUo0UaLUAUAH3VYrM5G17ZQjvwJm9WIhgJ8bXd8vNfX74lR6IBKOlhybDFPLSFttfSQTEgNppytPN2fvBtbJSjOsGUHNAdOtE8dx2QeYOHbAJAMCV
  
  ```

  

* 发送各种HTTP API就可以访问云端数据

  1. 数据库

     * 查询记录的API

     ```js
     POST https://api.weixin.qq.com/tcb/databasecollectionget?access_token=ACCESS_TOKEN
     请求参数：
     {
         "env":"xiaolibao-1nwqn"
         "query": 			"db.collection(\"god\").get()"
     }
     ```

     

* 存储

* 云函数



